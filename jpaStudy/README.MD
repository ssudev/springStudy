# 자바 ORM 표준 JPA 프로그래밍 - 기본편

## JPA에서 가장 중요한 2가지
- 객체와 관계형 데이터베이스 매핑하기
- 영속성 컨텍스트

### 영속성 컨텍스트
- JPA를 이해하는데 가장 중요한 용어
- "엔티티를 영구 저장하는 환경"이라는 뜻
- EnitiyManager.persit(entity); > DB에 저장하는게 아니고 엔티티를 영속성 컨텍스트에 저장한다는 뜻
- 영속성 컨텍스트는 논리적인 개념
- 눈에 보이지 않는다.
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근
- 엔티티 매니저 안에 영속성 컨텍스트라는 상태가 생김

### 엔티티의 생명주기
- 비영속
  - 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태
- 영속
  - 영속성 컨텍스트에 관리되는 상태
- 준영속
  - 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제
  - 삭제된 상태

### 영속성 컨텍스트의 이점
- 1차 캐시 : 굉장히 짧은 찰라에만 이점이 생긴다.
- 동일성 보장 : == 비교를 보장
- 트랜잭션을 지원하는 쓰기 지연 : transaction.commit() 을 해야 insert sql을 보낸다.
- 변경 감지
  1. flush()
  2. 엔티티와 스냅샷 비교
  3. update sql 생성
  4. flush()
  5. commit()
- 지연 로딩

### FLUSH
- 영속성 컨텍스트의 변경내용을 데이터베이스에 반영
- 플러시 발생
  - 변경 감지
  - 수정된 엔티티 쓰기 지연 SQL 저장소에 등록
  - 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송(등록, 수정, 삭제 쿼리)
- 영속성 컨텍스트를 플러시하는 방법
  - em.flush() : 직접 호출
  - 트랜잭션 커밋 : 자동 호출
  - JPQL 쿼리 실행 : 자동 호출
- 영속성 컨텍스트를 비우지 않음
- 영속성 컨텍스트의 변경내용을 데이터베이스에 동기화
- 트랜잭션이라는 작업 단위가 중요 -> 커밋 직전에만 동기화 하면 됨

### 준영속 상태
- 영속 -> 준영속
- 영속 상태의 엔티티가 영속성 컨텍스트에서 분리(detached)
- 영속성 컨텍스트가 제공하는 기능을 사용 못함
- 준영속 상태로 만드는 방법
  - em.detach(entity) : 특정 엔티티만 준영속 상태로 전환
  - em.clear() : 영속성 컨텍스트를 통채로 다 초기화